$(function () {
   
    ChangePersonalInfo();
    UpdateCoachProfessionalInfo();
    ChangeRole();
    ChangePasswordByAdmin();
    ChangePasswordByUser();
    SetClientGoal();
})

function ChangePersonalInfo() {
    $('#personalForm').on('submit', function (e) {
        e.preventDefault(); // prevent full form submission

        // Get form data - combine FirstName and LastName into FullName
        var firstName = $('#UserInfo_FirstName').val() || '';
        var lastName = $('#UserInfo_LastName').val() || '';
        var fullName = (firstName + ' ' + lastName).trim();

        var formData = {
            UserName: $('#UserInfo_UserName').val(),
            FullName: fullName,
            Email: $('#UserInfo_Email').val(),
            PhoneNumber: $('#UserInfo_PhoneNumber').val() || '',
            Age: parseInt($('#UserInfo_Age').val()) || null,
            Gender: parseInt($('#UserInfo_Gender').val()) || null
        };

        console.log('[UPDATE PERSONAL INFO] Sending data:', formData);

        $.ajax({
            url: '/Admin/Users/UpdatePersonalInfo',
            method: 'POST',
            data: formData,
            success: function (res) {
                console.log('[UPDATE PERSONAL INFO] Response:', res);
                if (res.succeeded || res.Succeeded) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: res.message || res.Message || 'Personal information updated successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res.message || res.Message || 'Failed to update personal information.'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('[UPDATE PERSONAL INFO] Error:', error);
                console.error('[UPDATE PERSONAL INFO] Response:', xhr.responseText);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong while updating personal information.'
                });
            }
        });

    });

}

function UpdateCoachProfessionalInfo() {
    // Check if professional form exists
    if ($('#professionalForm').length === 0) {
        console.log('[UPDATE COACH PROF INFO] Form not found - user is not a coach');
        return;
    }

    console.log('[UPDATE COACH PROF INFO] Initializing form handler');

    $('#professionalForm').on('submit', function (e) {
        e.preventDefault();

        console.log('[UPDATE COACH PROF INFO] Form submitted');

        // Get selected specialties
        var specialties = [];
        $('input[name="specialties"]:checked').each(function() {
            specialties.push($(this).val());
        });

        // Get form data using correct IDs generated by asp-for
        var formData = {
            UserName: $('#hiddenUserName').val(),
            ExperienceYears: parseInt($('#coachProfessionalInfo_ExperienceYears').val()) || 0,
            Salary: parseFloat($('#coachProfessionalInfo_Salary').val()) || 0,
            About: $('#coachProfessionalInfo_About').val() || '',
            Certificates: $('#coachProfessionalInfo_Certificates').val() || '',
            Specialties: specialties.join(', ')
        };

        console.log('[UPDATE COACH PROF INFO] UserName:', formData.UserName);
        console.log('[UPDATE COACH PROF INFO] Sending data:', formData);

        $.ajax({
            url: '/Admin/Users/UpdateCoachProfessionalInfo',
            method: 'POST',
            data: formData,
            success: function (res) {
                console.log('[UPDATE COACH PROF INFO] Response:', res);
                if (res.succeeded || res.Succeeded) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: res.message || res.Message || 'Professional information updated successfully!',
                        timer: 2500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res.message || res.Message || 'Failed to update professional information.'
                    });
                }
            },
            error: function (xhr, status, error) {
                console.error('[UPDATE COACH PROF INFO] Error:', error);
                console.error('[UPDATE COACH PROF INFO] Response:', xhr.responseText);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong while updating professional information.'
                });
            }
        });
    });
}

function ChangeRole() {

    $('#select-role').on('change', function () {
        var oldRole= $(this).val();
        Swal.fire({
            title: 'Change Role',
            text: 'Are you sure you want to change the role?',
            icon: 'warning',
            showConfirmButton: true,
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, change it!'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    method: 'POST',
                    url: '/Admin/Users/ChangeUserRole',
                    data: {
                        UserName: $('#hiddenUserName').val(),
                        Role: $('#select-role').val()
                    },
                    success: function (response) {
                        if (response.Succeeded) {
                            location.reload();

                            Swal.fire({
                                title: "Role Changed",
                                text: response.message,
                                icon: "success"
                            });
                            

                        } else {
                            Swal.fire({
                                title: "Error",
                                text: response.message || "Failed to change role.",
                                icon: "error"
                            });

                            // Revert to old role on failure
                            $('#select-role').val(oldRole);
                        }
                    },
                    error: function () {
                        Swal.fire("Failed, Try Again");
                    }
                });
            }
        });
    });
}

function ChangePasswordByAdmin() {
    $('#AdminFunctions').on('submit', function (e) {
        e.preventDefault();

        
        $.ajax({
            url: '/Admin/Users/ChangePasswordByAdmin',
            method: 'POST',
            data: {
                'UserInfo.UserName': $('#hiddenUserName').val(),
                'ChangePasswordByAdmin.Password': $('#ChangePasswordByAdmin_Password').val(),
                'ChangePasswordByAdmin.ConfirmPassword': $('#ChangePasswordByAdmin_ConfirmPassword').val()
            }, 
            success: function (res) {
                if (res.success || res.Success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: res.message || res.Message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#AdminFunctions')[0].reset();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res.message || res.Message
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong while changing the password.'
                });
            }
        });
    });
}

function ChangePasswordByUser() {
    $('#passwordForm').on('submit', function (e) {
        e.preventDefault();



        $.ajax({
            url: '/Admin/Users/ChangePasswordByUser',
            method: 'POST',
            data: {
                'UserInfo.UserName': $('#hiddenUserName').val(),
                'ChangePasswordByUser.OldPassword': $('#ChangePasswordByUser_OldPassword').val(),
                'ChangePasswordByUser.Password': $('#ChangePasswordByUser_Password').val(),
                'ChangePasswordByUser.ConfirmPassword': $('#ChangePasswordByUser_ConfirmPassword').val()
            },
            success: function (res) {
                if (res.success || res.Success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: res.message || res.Message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    $('#passwordForm')[0].reset();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed',
                        text: res.message || res.Message
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Something went wrong while changing the password.'
                });
            }
        });
    });
}


function SetClientGoal() {
    $('#goalsForm').on('submit', function (e) {
        e.preventDefault();
        var UserName = $('#hiddenUserName').val();
        var Height = $('#clientPhysicalInfo_Height').val();
        var StartWeight = $('#clientPhysicalInfo_StartWeight').val();
        var Goal = $('#clientPhysicalInfo_Goal').val();

        console.log(UserName, Height, StartWeight, Goal);
        $.ajax({
            url: '/Admin/Users/UpdateClientGoals',
            method: 'POST',
            data: {
                userName: UserName,
                height: Height,
                startWeight: StartWeight,
                goal: Goal
            },
            success: function (response) {
                Swal.fire("Updated", "Data has been updated", "success");
                $('#goalsForm')[0].reset();
            },
            error: function () {
                Swal.fire("Error", "update the data later", "error");
            }
        });
    });

    
}
